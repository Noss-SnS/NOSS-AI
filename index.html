<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>NOSS AI - الإصدار المطور</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;900&family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<style>
  :root {
    --bg-color: #050505;
    --card-bg: rgba(20, 20, 20, 0.95);
    --primary: #00f2ff;
    --secondary: #bd00ff;
    --text: #ffffff;
    --glass: rgba(255, 255, 255, 0.08);
    --nav-height: 70px;
  }

  * {margin:0;padding:0;box-sizing:border-box; -webkit-tap-highlight-color: transparent;}
  
  body {
    background-color: var(--bg-color);
    color: var(--text);
    font-family: 'Tajawal', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
    padding-bottom: 90px; /* مساحة للقائمة السفلية في الموبايل */
  }

  /* --- خلفية المصفوفة --- */
  .matrix-bg {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
    background: radial-gradient(circle at center, #111 0%, #000 100%);
  }
  .grid-lines {
    position: absolute; width: 100%; height: 100%;
    background-image: linear-gradient(rgba(0, 242, 255, 0.05) 1px, transparent 1px),
    linear-gradient(90deg, rgba(0, 242, 255, 0.05) 1px, transparent 1px);
    background-size: 40px 40px;
    animation: gridMove 20s linear infinite;
    opacity: 0.5;
  }
  @keyframes gridMove { from {background-position: 0 0;} to {background-position: 0 40px;} }

  /* --- نظام التنقل (متجاوب) --- */
  nav {
    position: fixed; top: 0; width: 100%; z-index: 1000;
    background: rgba(5,5,5,0.9); backdrop-filter: blur(15px);
    border-bottom: 1px solid rgba(255,255,255,0.1);
    height: var(--nav-height); display: flex; align-items: center;
    transition: 0.3s;
  }

  .nav-content {
    width: 100%; max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
  }

  .logo { font-size: 24px; font-weight: 900; color: white; letter-spacing: 1px; }
  .logo span { color: var(--primary); }

  /* أزرار التنقل (Desktop) */
  .nav-btns { display: flex; gap: 10px; }
  .nav-btns button {
    background: transparent; color: #888; border: none; padding: 10px 15px;
    font-size: 16px; font-weight: 700; cursor: pointer; border-radius: 15px;
    transition: 0.3s; display: flex; align-items: center; gap: 8px;
  }
  .nav-btns button.active, .nav-btns button:hover {
    color: var(--primary); background: var(--glass);
  }

  /* --- تحويل القائمة للموبايل (Bottom Bar) --- */
  @media(max-width: 768px) {
    nav {
      top: auto; bottom: 0; border-bottom: none; border-top: 1px solid rgba(255,255,255,0.1);
      padding-bottom: env(safe-area-inset-bottom);
      height: auto;
    }
    .nav-content { padding: 10px 20px; }
    .logo, .user-section-desk { display: none; } /* إخفاء الشعار في الأسفل */
    .nav-btns { width: 100%; justify-content: space-around; }
    .nav-btns button {
      flex-direction: column; font-size: 12px; gap: 5px; padding: 5px;
    }
    .nav-btns button i { font-size: 20px; margin-bottom: 2px; }
    
    /* شعار علوي للموبايل */
    .mobile-header {
      display: flex; justify-content: space-between; align-items: center; padding: 15px 20px;
      position: fixed; top: 0; width: 100%; z-index: 999;
      background: rgba(5,5,5,0.9); backdrop-filter: blur(10px);
    }
  }
  @media(min-width: 769px) { .mobile-header { display: none; } }

  /* --- بروفايل المستخدم --- */
  .user-mini {
    display: flex; align-items: center; gap: 10px; cursor: pointer;
    background: var(--glass); padding: 5px 12px 5px 5px; border-radius: 30px; border: 1px solid #333;
  }
  .user-mini img { width: 32px; height: 32px; border-radius: 50%; }
  .user-mini span { font-size: 14px; font-weight: bold; }

  /* --- الصفحات --- */
  .page {
    display: none; padding: 100px 20px 40px; max-width: 900px; margin: 0 auto;
    animation: fadeIn 0.4s ease;
  }
  .page.active { display: block; }
  @media(max-width: 768px) { .page { padding-top: 80px; } }
  @keyframes fadeIn { from {opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

  h1 { font-size: 32px; text-align: center; margin-bottom: 10px; color: white; }
  .subtitle { text-align: center; color: #888; margin-bottom: 30px; font-size: 16px; }

  /* --- الدردشة --- */
  .chat-box {
    background: #111; border-radius: 20px; border: 1px solid #333;
    height: 65vh; display: flex; flex-direction: column; overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.5);
  }
  .messages {
    flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
  }
  .msg {
    max-width: 85%; padding: 12px 18px; border-radius: 18px; font-size: 16px; line-height: 1.5;
    position: relative; word-wrap: break-word;
  }
  .msg.user {
    align-self: flex-end; background: #222; color: white; border-bottom-right-radius: 4px;
    border: 1px solid #444;
  }
  .msg.ai {
    align-self: flex-start; background: rgba(0, 242, 255, 0.1); color: var(--primary);
    border-bottom-left-radius: 4px; border: 1px solid rgba(0, 242, 255, 0.3);
  }
  
  .input-area {
    padding: 15px; background: #1a1a1a; border-top: 1px solid #333; display: flex; gap: 10px; align-items: center;
  }
  .input-area input {
    flex: 1; background: #050505; border: 1px solid #333; color: white;
    padding: 15px; border-radius: 25px; outline: none; font-size: 16px;
  }
  .mic-btn, .send-btn {
    width: 50px; height: 50px; border-radius: 50%; border: none; cursor: pointer;
    display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.3s;
  }
  .mic-btn { background: #222; color: #aaa; }
  .mic-btn.listening { background: #ff3333; color: white; animation: pulse 1s infinite; }
  .send-btn { background: var(--primary); color: black; }
  
  @keyframes pulse { 0% {transform:scale(1);} 50% {transform:scale(1.1);} 100% {transform:scale(1);} }

  /* --- أدوات الفيديو والصور --- */
  .tool-input {
    width: 100%; padding: 18px; background: #111; border: 2px solid #333;
    border-radius: 15px; color: white; font-size: 16px; margin-bottom: 20px; outline: none;
  }
  .tool-input:focus { border-color: var(--primary); }
  
  .gen-btn {
    width: 100%; padding: 18px; background: linear-gradient(90deg, var(--secondary), var(--primary));
    border: none; border-radius: 15px; color: white; font-size: 18px; font-weight: bold; cursor: pointer;
    box-shadow: 0 5px 20px rgba(0, 242, 255, 0.3); transition: 0.3s;
  }
  .gen-btn:active { transform: scale(0.98); }

  /* --- تسجيل الدخول (Modal) --- */
  .auth-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000;
    background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
    display: flex; align-items: center; justify-content: center; padding: 20px;
  }
  .auth-card {
    background: #151515; padding: 40px; border-radius: 30px; text-align: center;
    border: 1px solid var(--primary); max-width: 400px; width: 100%;
    box-shadow: 0 0 50px rgba(0, 242, 255, 0.2);
  }
  .avatar-grid {
    display: flex; justify-content: center; gap: 15px; margin: 20px 0;
  }
  .avatar-option {
    width: 50px; height: 50px; border-radius: 50%; cursor: pointer; border: 2px solid transparent;
    transition: 0.3s; opacity: 0.6;
  }
  .avatar-option.selected { border-color: var(--primary); opacity: 1; transform: scale(1.1); }
  
  .loader {
    width: 100%; height: 4px; background: #222; margin-top: 20px; display: none;
  }
  .loader-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s; }
  
  .result-media { width: 100%; border-radius: 15px; margin-top: 20px; display: none; border: 2px solid #333; }

</style>
</head>
<body>

<div class="matrix-bg"><div class="grid-lines"></div></div>

<!-- هيدر الموبايل -->
<div class="mobile-header">
  <div class="logo">NOSS <span>AI</span></div>
  <div class="user-mini" onclick="logout()">
    <img id="mobUserImg" src="" alt="">
  </div>
</div>

<nav>
  <div class="nav-content">
    <div class="logo">NOSS <span>AI</span></div>
    
    <div class="nav-btns">
      <button class="active" onclick="switchTab('chat')"><i class="fas fa-comment-dots"></i> <span>محادثة</span></button>
      <button onclick="switchTab('video')"><i class="fas fa-video"></i> <span>فيديو</span></button>
      <button onclick="switchTab('image')"><i class="fas fa-image"></i> <span>صور</span></button>
    </div>

    <div class="user-section-desk">
      <div class="user-mini" onclick="logout()">
        <img id="deskUserImg" src="" alt="">
        <span id="deskUserName"></span>
      </div>
    </div>
  </div>
</nav>

<!-- === صفحة الشات === -->
<div id="chat" class="page active">
  <div class="chat-box">
    <div class="messages" id="messages">
      <!-- الرسائل ستظهر هنا -->
    </div>
    <div class="input-area">
      <button class="mic-btn" id="micBtn" onclick="toggleVoice()"><i class="fas fa-microphone"></i></button>
      <input type="text" id="msgInput" placeholder="تحدث مع NOSS..." onkeypress="if(event.key==='Enter') sendMsg()">
      <button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<!-- === صفحة الفيديو === -->
<div id="video" class="page">
  <h1>استوديو الفيديو</h1>
  <p class="subtitle">محرك سينمائي يحول النص إلى حركة</p>
  
  <input type="text" class="tool-input" id="vidPrompt" placeholder="وصف المشهد (مثال: سيارة رياضية تحت المطر)">
  <button class="gen-btn" onclick="generateVideo()">إنشاء مشهد <i class="fas fa-film"></i></button>
  
  <div class="loader" id="vidLoader"><div class="loader-bar" id="vidBar"></div></div>
  <video id="resultVideo" class="result-media" controls loop playsinline></video>
</div>

<!-- === صفحة الصور === -->
<div id="image" class="page">
  <h1>مولد الصور 8K</h1>
  <p class="subtitle">دقة فائقة وتفاصيل خيالية</p>
  
  <input type="text" class="tool-input" id="imgPrompt" placeholder="صف الصورة بدقة...">
  <button class="gen-btn" onclick="generateImage()">رسم الصورة <i class="fas fa-paint-brush"></i></button>
  
  <div class="loader" id="imgLoader"><div class="loader-bar" id="imgBar"></div></div>
  <img id="resultImage" class="result-media" alt="AI Art">
</div>

<!-- === شاشة الدخول (Local Auth) === -->
<div id="authModal" class="auth-overlay">
  <div class="auth-card">
    <h2 style="color:white;margin-bottom:10px;">إعداد البروفايل</h2>
    <p style="color:#888;margin-bottom:20px;">اختر هويتك الرقمية (يتم الحفظ محلياً)</p>
    
    <div class="avatar-grid">
      <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" class="avatar-option selected" onclick="selectAvatar(this)">
      <img src="https://cdn-icons-png.flaticon.com/512/4140/4140037.png" class="avatar-option" onclick="selectAvatar(this)">
      <img src="https://cdn-icons-png.flaticon.com/512/4140/4140047.png" class="avatar-option" onclick="selectAvatar(this)">
    </div>
    
    <input type="text" id="usernameInput" class="tool-input" placeholder="اسمك المستعار" style="text-align:center;">
    <button class="gen-btn" onclick="saveProfile()">بدء النظام</button>
  </div>
</div>

<!-- Canvas مخفي للمعالجة -->
<canvas id="renderCanvas" style="display:none;"></canvas>

<script>
// --- 1. إدارة النظام والمؤثرات الصوتية ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function playSound(type) {
  if (audioCtx.state === 'suspended') audioCtx.resume();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  
  if (type === 'click') {
    osc.frequency.setValueAtTime(600, audioCtx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
    gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
    osc.start(); osc.stop(audioCtx.currentTime + 0.1);
  } else if (type === 'msg') {
    osc.frequency.setValueAtTime(800, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
    osc.start(); osc.stop(audioCtx.currentTime + 0.15);
  }
}

function switchTab(id) {
  playSound('click');
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.nav-btns button').forEach(b => b.classList.remove('active'));
  event.currentTarget.classList.add('active');
}

// --- 2. نظام الدخول المحلي ---
let userProfile = JSON.parse(localStorage.getItem('nossUser'));
let selectedAvatarSrc = document.querySelector('.avatar-option.selected').src;

function checkAuth() {
  if (!userProfile) {
    document.getElementById('authModal').style.display = 'flex';
  } else {
    document.getElementById('authModal').style.display = 'none';
    updateUI(userProfile);
    if(chatHistory.length === 0) addMsg("ai", `أهلاً بعودتك أيها القائد ${userProfile.name}. الأنظمة جاهزة.`);
  }
}

function selectAvatar(el) {
  document.querySelectorAll('.avatar-option').forEach(img => img.classList.remove('selected'));
  el.classList.add('selected');
  selectedAvatarSrc = el.src;
  playSound('click');
}

function saveProfile() {
  const name = document.getElementById('usernameInput').value.trim() || "Ghost";
  userProfile = { name: name, avatar: selectedAvatarSrc };
  localStorage.setItem('nossUser', JSON.stringify(userProfile));
  checkAuth();
  playSound('msg');
}

function updateUI(user) {
  document.getElementById('deskUserName').textContent = user.name;
  document.getElementById('deskUserImg').src = user.avatar;
  document.getElementById('mobUserImg').src = user.avatar;
}

function logout() {
  if(confirm('هل تريد تسجيل الخروج ومسح البيانات المحلية؟')) {
    localStorage.removeItem('nossUser');
    location.reload();
  }
}

// --- 3. نظام الشات الذكي (مع ذاكرة وصوت) ---
let chatHistory = []; // ذاكرة قصيرة
const synth = window.speechSynthesis;
let recognition;

if ('webkitSpeechRecognition' in window) {
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'ar-SA';
  recognition.continuous = false;
  recognition.onresult = (event) => {
    const text = event.results[0][0].transcript;
    document.getElementById('msgInput').value = text;
    toggleVoice(); // إيقاف الاستماع
    sendMsg();
  };
}

function toggleVoice() {
  const btn = document.getElementById('micBtn');
  if (btn.classList.contains('listening')) {
    btn.classList.remove('listening');
    if(recognition) recognition.stop();
  } else {
    btn.classList.add('listening');
    if(recognition) recognition.start();
  }
}

function addMsg(role, text) {
  const div = document.createElement('div');
  div.className = `msg ${role}`;
  div.textContent = text;
  document.getElementById('messages').appendChild(div);
  document.getElementById('messages').scrollTop = 10000;
  
  if(role === 'ai') {
    playSound('msg');
    // قراءة الرد (Text to Speech)
    /* ميزة اختيارية: فعل السطر التالي لتفعيل القراءة الآلية */
    // speakText(text); 
  }
}

function speakText(txt) {
  if(synth.speaking) synth.cancel();
  const utter = new SpeechSynthesisUtterance(txt);
  utter.lang = 'ar-SA';
  synth.speak(utter);
}

async function sendMsg() {
  const input = document.getElementById('msgInput');
  const txt = input.value.trim();
  if(!txt) return;

  addMsg('user', txt);
  input.value = '';
  playSound('click');

  // إضافة للذاكرة (نحتفظ بآخر 4 رسائل فقط لتوفير حجم الرابط)
  chatHistory.push(`User: ${txt}`);
  if(chatHistory.length > 4) chatHistory.shift();

  // بناء سياق البرومبت
  const systemPrompt = `You are NOSS AI, a futuristic assistant. User name is ${userProfile.name}. Reply in Arabic mostly. Be cool and concise.`;
  const context = chatHistory.join('\n');
  const finalPrompt = `${systemPrompt}\n${context}\nAI:`;

  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'msg ai';
  loadingDiv.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
  document.getElementById('messages').appendChild(loadingDiv);

  try {
    const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(finalPrompt)}`);
    const aiTxt = await res.text();
    loadingDiv.remove();
    addMsg('ai', aiTxt);
    chatHistory.push(`AI: ${aiTxt}`);
  } catch(e) {
    loadingDiv.textContent = "حدث خطأ في الاتصال";
  }
}

// --- 4. محرك الصور والفيديو ---
async function generateImage() {
  const prompt = document.getElementById('imgPrompt').value;
  if(!prompt) return;
  
  startLoad('img');
  
  const seed = Math.floor(Math.random()*1000);
  const enhanced = `${prompt}, 8k resolution, cinematic lighting, hyperrealistic, detailed texture, masterpiece`;
  const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(enhanced)}?width=1024&height=1024&nologo=true&seed=${seed}`;
  
  const img = document.getElementById('resultImage');
  img.onload = () => stopLoad('img');
  img.src = url;
}

async function generateVideo() {
  const prompt = document.getElementById('vidPrompt').value;
  if(!prompt) return;
  
  startLoad('vid');
  
  // 1. جلب الصورة
  const imgUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt + " cinematic wide shot")}_${Math.random()}?width=1280&height=720&nologo=true`;
  
  const imgObj = new Image();
  imgObj.crossOrigin = "Anonymous";
  imgObj.src = imgUrl;
  
  imgObj.onload = async () => {
    // 2. تحريك الصورة (Pan & Zoom)
    const blob = await recordCanvas(imgObj);
    const videoUrl = URL.createObjectURL(blob);
    const vid = document.getElementById('resultVideo');
    vid.src = videoUrl;
    stopLoad('vid');
    vid.play();
  };
}

function startLoad(type) {
  document.getElementById(`${type}Loader`).style.display = 'block';
  document.getElementById(`${type}Bar`).style.width = '20%';
  document.getElementById(`result${type === 'img' ? 'Image' : 'Video'}`).style.display = 'none';
  setTimeout(() => document.getElementById(`${type}Bar`).style.width = '70%', 1000);
}

function stopLoad(type) {
  document.getElementById(`${type}Loader`).style.display = 'none';
  document.getElementById(`result${type === 'img' ? 'Image' : 'Video'}`).style.display = 'block';
  playSound('msg');
}

// تسجيل الكانفاس للفيديو
function recordCanvas(img) {
  return new Promise(resolve => {
    const canvas = document.getElementById('renderCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 1280; canvas.height = 720;
    
    const stream = canvas.captureStream(30);
    const recorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });
    const chunks = [];
    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => resolve(new Blob(chunks, {type: 'video/webm'}));
    
    recorder.start();
    let frame = 0;
    const max = 120; // 4 ثواني
    
    function loop() {
      if(frame > max) { recorder.stop(); return; }
      
      const scale = 1 + (frame * 0.002); // تكبير بطيء
      const w = canvas.width * scale;
      const h = canvas.height * scale;
      const x = (canvas.width - w) / 2;
      const y = (canvas.height - h) / 2;
      
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, x, y, w, h);
      
      // تأثير سينمائي
      ctx.fillStyle = `rgba(0,0,0,${0.2 - (frame/max)*0.2})`; // Fade In
      ctx.fillRect(0,0,canvas.width,canvas.height);
      
      frame++;
      requestAnimationFrame(loop);
    }
    loop();
  });
}

// بدء التشغيل
checkAuth();

</script>
</body>
</html>
